---
layout: post
title: "Making POST requests from withing a Windows Phone 8 Cordova project"
date: 2013-08-12 15:16
author: saguiitay
comments: true
categories: [.Net, Development, Windows Phone]
tags: [c#, Cordova, JavaScript, PhoneGap, Windows Phone]
---
So you've created your Cordova/PhoneGap application, and now you need to make a POST request to a service on the web. You'll quickly find that this is not easily done. Here's a simple, extendable solution for that, using Cordova's Commands mechanism: First, we'll create a new Command:
Code Snippet

1.  <span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">class </span><span style="background:#ffffff;color:#2b91af;">PhonegapWindowsPhonePost</span><span style="background:#ffffff;color:#000000;"> : </span><span style="background:#ffffff;color:#2b91af;">BaseCommand</span>
2.  <span style="background:#ffffff;color:#000000;">{</span>
3.      <span style="background:#ffffff;color:#000000;">[</span><span style="background:#ffffff;color:#2b91af;">DataContract</span><span style="background:#ffffff;color:#000000;">]</span>
4.      <span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">class </span><span style="background:#ffffff;color:#2b91af;">PhonegapWindowsPhonePostObject</span>
5.      <span style="background:#ffffff;color:#000000;">{</span>
6.          <span style="background:#ffffff;color:#000000;">[</span><span style="background:#ffffff;color:#2b91af;">DataMember</span><span style="background:#ffffff;color:#000000;">(IsRequired = </span><span style="background:#ffffff;color:#0000ff;">false</span><span style="background:#ffffff;color:#000000;">, Name = </span><span style="background:#ffffff;color:#a31515;">"url"</span><span style="background:#ffffff;color:#000000;">)]</span>
7.          <span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> url;</span>
8.          <span style="background:#ffffff;color:#000000;">[</span><span style="background:#ffffff;color:#2b91af;">DataMember</span><span style="background:#ffffff;color:#000000;">(IsRequired = </span><span style="background:#ffffff;color:#0000ff;">false</span><span style="background:#ffffff;color:#000000;">, Name = </span><span style="background:#ffffff;color:#a31515;">"type"</span><span style="background:#ffffff;color:#000000;">)]</span>
9.          <span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> type;</span>
10.         <span style="background:#ffffff;color:#000000;">[</span><span style="background:#ffffff;color:#2b91af;">DataMember</span><span style="background:#ffffff;color:#000000;">(IsRequired = </span><span style="background:#ffffff;color:#0000ff;">false</span><span style="background:#ffffff;color:#000000;">, Name = </span><span style="background:#ffffff;color:#a31515;">"data"</span><span style="background:#ffffff;color:#000000;">)]</span>
11.         <span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">dynamic</span><span style="background:#ffffff;color:#000000;"> data;</span>
12.     <span style="background:#ffffff;color:#000000;">}</span>
13. 14. 15.     <span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">void</span><span style="background:#ffffff;color:#000000;"> post(</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> options)</span>
16.     <span style="background:#ffffff;color:#000000;">{</span>
17.         <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> allArgs = Newtonsoft.Json.</span><span style="background:#ffffff;color:#2b91af;">JsonConvert</span><span style="background:#ffffff;color:#000000;">.DeserializeObject\<</span><span style="background:#ffffff;color:#2b91af;">List</span><span style="background:#ffffff;color:#000000;">\<</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">\>\>(options);</span>
18. 19.         <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> methodArgs = Newtonsoft.Json.</span><span style="background:#ffffff;color:#2b91af;">JsonConvert</span><span style="background:#ffffff;color:#000000;">.DeserializeObject\<</span><span style="background:#ffffff;color:#2b91af;">PhonegapWindowsPhonePostObject</span><span style="background:#ffffff;color:#000000;">\>(allArgs[0]);</span>
20.         <span style="background:#ffffff;color:#0000ff;">try</span>
21.         <span style="background:#ffffff;color:#000000;">{</span>
22.             <span style="background:#ffffff;color:#000000;">System.Windows.</span><span style="background:#ffffff;color:#2b91af;">Deployment</span><span style="background:#ffffff;color:#000000;">.Current.Dispatcher.BeginInvoke(() =\></span>
23.                 <span style="background:#ffffff;color:#000000;">{</span>
24.                     <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> wc = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">WebClient</span><span style="background:#ffffff;color:#000000;">();</span>
25.                     <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> uri = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">Uri</span><span style="background:#ffffff;color:#000000;">(methodArgs.url);</span>
26.                     <span style="background:#ffffff;color:#000000;">wc.Encoding = </span><span style="background:#ffffff;color:#2b91af;">Encoding</span><span style="background:#ffffff;color:#000000;">.UTF8;</span>
27.                     <span style="background:#ffffff;color:#000000;">wc.Headers[</span><span style="background:#ffffff;color:#2b91af;">HttpRequestHeader</span><span style="background:#ffffff;color:#000000;">.ContentType] = </span><span style="background:#ffffff;color:#a31515;">"application/x-www-form-urlencoded"</span><span style="background:#ffffff;color:#000000;">;</span>
28.                     <span style="background:#ffffff;color:#000000;">wc.UploadStringCompleted += WebClient\_UploadStringCompleted;</span>
29.                     <span style="background:#ffffff;color:#000000;">wc.UploadStringAsync(uri, methodArgs.type, methodArgs.data);</span>
30.                 <span style="background:#ffffff;color:#000000;">});</span>
31. 32.         <span style="background:#ffffff;color:#000000;">}</span>
33.         <span style="background:#ffffff;color:#0000ff;">catch</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#2b91af;">Exception</span><span style="background:#ffffff;color:#000000;"> ex)</span>
34.         <span style="background:#ffffff;color:#000000;">{</span>
35.             <span style="background:#ffffff;color:#2b91af;">Console</span><span style="background:#ffffff;color:#000000;">.WriteLine(ex.Message);</span>
36.         <span style="background:#ffffff;color:#000000;">}</span>
37.     <span style="background:#ffffff;color:#000000;">}</span>
38.     <span style="background:#ffffff;color:#0000ff;">private </span><span style="background:#ffffff;color:#0000ff;">void</span><span style="background:#ffffff;color:#000000;"> WebClient\_UploadStringCompleted(</span><span style="background:#ffffff;color:#0000ff;">object</span><span style="background:#ffffff;color:#000000;"> sender, </span><span style="background:#ffffff;color:#2b91af;">UploadStringCompletedEventArgs</span><span style="background:#ffffff;color:#000000;"> e)</span>
39.     <span style="background:#ffffff;color:#000000;">{</span>
40.         <span style="background:#ffffff;color:#0000ff;">try</span>
41.         <span style="background:#ffffff;color:#000000;">{</span>
42.             <span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (e.Result != </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">)</span>
43.                 <span style="background:#ffffff;color:#000000;">DispatchCommandResult(</span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">PluginResult</span><span style="background:#ffffff;color:#000000;">(</span><span style="background:#ffffff;color:#2b91af;">PluginResult</span><span style="background:#ffffff;color:#000000;">.</span><span style="background:#ffffff;color:#2b91af;">Status</span><span style="background:#ffffff;color:#000000;">.OK, e.Result));</span>
44.             <span style="background:#ffffff;color:#0000ff;">else</span>
45.                 <span style="background:#ffffff;color:#000000;">DispatchCommandResult(</span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">PluginResult</span><span style="background:#ffffff;color:#000000;">(</span><span style="background:#ffffff;color:#2b91af;">PluginResult</span><span style="background:#ffffff;color:#000000;">.</span><span style="background:#ffffff;color:#2b91af;">Status</span><span style="background:#ffffff;color:#000000;">.ERROR, </span><span style="background:#ffffff;color:#a31515;">"Error 401"</span><span style="background:#ffffff;color:#000000;">));</span>
46.         <span style="background:#ffffff;color:#000000;">}</span>
47.         <span style="background:#ffffff;color:#0000ff;">catch</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#2b91af;">Exception</span><span style="background:#ffffff;color:#000000;"> ex)</span>
48.         <span style="background:#ffffff;color:#000000;">{</span>
49.             <span style="background:#ffffff;color:#000000;">DispatchCommandResult(</span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">PluginResult</span><span style="background:#ffffff;color:#000000;">(</span><span style="background:#ffffff;color:#2b91af;">PluginResult</span><span style="background:#ffffff;color:#000000;">.</span><span style="background:#ffffff;color:#2b91af;">Status</span><span style="background:#ffffff;color:#000000;">.ERROR, ex.Message));</span>
50.             <span style="background:#ffffff;color:#008000;">// no http status code available</span>
51.         <span style="background:#ffffff;color:#000000;">}</span>
52.     <span style="background:#ffffff;color:#000000;">}</span>
53. <span style="background:#ffffff;color:#000000;">}</span>

This will allow us to call the "post" command, and pass the URL, Method and data to the WebClient. Next, we'll add our command to the list of plugins in the config.xml file, to make it usable in our JavaScript code:
Code Snippet

<span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#a31515;">plugins</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#a31515;">plugin </span><span style="background:#ffffff;color:#ff0000;">name</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">"</span><span style="background:#ffffff;color:#0000ff;">Device</span><span style="background:#ffffff;color:#000000;">"</span><span style="background:#ffffff;color:#0000ff;">/\></span>

    // ... <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#a31515;">plugin </span><span style="background:#ffffff;color:#ff0000;">name</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">"</span><span style="background:#ffffff;color:#0000ff;">InAppBrowser</span><span style="background:#ffffff;color:#000000;">"</span><span style="background:#ffffff;color:#0000ff;">/\></span> <span style="font-size:10pt;">    </span>***<span style="font-size:10pt;color:#0000ff;">\<</span><span style="font-size:10pt;color:#a31515;">plugin </span><span style="font-size:10pt;color:#ff0000;">name</span><span style="font-size:10pt;color:#0000ff;">=</span><span style="font-size:10pt;">"</span><span style="font-size:10pt;color:#0000ff;">PhonegapWindowsPhonePost</span><span style="font-size:10pt;">"</span><span style="font-size:10pt;color:#0000ff;"> /\></span>*** <span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#a31515;">plugins</span><span style="background:#ffffff;color:#0000ff;">\></span>

All that remains now, if to invoke the command from JavaScript:
Code Snippet

<span style="background:#ffffff;color:#008000;">// Define the settings object which will be provided to the command</span> <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> settings = [{</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">url: </span><span style="background:#ffffff;color:#a31515;">"\<Provide web service URL here\>"</span><span style="background:#ffffff;color:#000000;">,</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">type: </span><span style="background:#ffffff;color:#a31515;">"POST"</span><span style="background:#ffffff;color:#000000;">,</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">data: </span><span style="background:#ffffff;color:#a31515;">"\<Pass any data you want here"</span> <span style="font-size:10pt;">}];</span> <span style="background:#ffffff;color:#008000;">// Define the success callback method</span> <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> success = </span><span style="background:#ffffff;color:#0000ff;">function</span><span style="background:#ffffff;color:#000000;">(result) {</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#008000;">// Do something with the result</span> <span style="background:#ffffff;color:#000000;">}</span><span style="background:#ffffff;color:#000000;">;</span> <span style="background:#ffffff;color:#008000;">// Invoke the "post" method on the PhonegapWindowsPhonePost command</span> <span style="background:#ffffff;color:#000000;">cordova.exec(success, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#a31515;">"PhonegapWindowsPhonePost"</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#a31515;">"post"</span><span style="background:#ffffff;color:#000000;">, settings);</span>



