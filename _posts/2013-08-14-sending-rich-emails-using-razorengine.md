---
layout: post
title: "Sending rich emails using RazorEngine"
date: 2013-08-14 23:24
author: saguiitay
comments: true
categories: [.Net, Development]
tags: [c#, development, email, MVC, RazorEngine]
---
RazorEngine is a templating engine based on Microsoft's Razor parsing engine. One of its most common uses it to generate HTML for emails. This post shows how to use the RazorEngine in a simple and elegant fashion. Let's start with some basic code to create our MailMessage, which we will expand and build throughout this post:

Code Snippet

<span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> htmlTemplate = </span><span style="background:#ffffff;color:#a31515;">""</span><span style="background:#ffffff;color:#000000;">; </span><span style="background:#ffffff;color:#008000;">// </span><span style="background:#ffffff;color:#00008b;">TODO: Load the template from a CSHTML file</span> <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> config = </span><span style="background:#ffffff;color:#0000ff;">new</span><span style="background:#ffffff;color:#2b91af;">TemplateServiceConfiguration</span><span style="background:#ffffff;color:#000000;">();</span> <span style="background:#ffffff;color:#0000ff;">using</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> service = </span><span style="background:#ffffff;color:#0000ff;">new</span><span style="background:#ffffff;color:#2b91af;">TemplateService</span><span style="background:#ffffff;color:#000000;">(config))</span> <span style="font-size:10pt;">{</span> <span style="background:#ffffff;color:#000000;">    resultHtml = service.Parse(htmlTemplate, model, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">);</span> <span style="font-size:10pt;">}</span> <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> mailMessage = </span><span style="background:#ffffff;color:#0000ff;">new</span><span style="background:#ffffff;color:#2b91af;">MailMessage</span> <span style="font-size:10pt;">{</span> <span style="background:#ffffff;color:#000000;">    BodyEncoding = </span><span style="background:#ffffff;color:#2b91af;">Encoding</span><span style="background:#ffffff;color:#000000;">.UTF8,</span> <span style="background:#ffffff;color:#000000;">    IsBodyHtml = </span><span style="background:#ffffff;color:#0000ff;">true</span><span style="background:#ffffff;color:#000000;">,</span> <span style="font-size:10pt;">    Body = resultHtml</span> <span style="font-size:10pt;">};</span>

This is our most basic code - it initializes a new RazorEngine TemplateService instance, parses the provided template with the provided model, and create a new instance of MailMessage. Let's starting enhancing this code into something more useful.

Adding support for AlternativeViews
-----------------------------------

If we want to support alternative views, in case the recipient is using a less advanced mail client, or just prefer plain text over rich text, we can load 2 templates (one for RichText, and one for plain text), and parse both. While we're at it, we'll make the assignment of the body of the message a bit smarter too - if we have only a RichText body, we'll use only that; if we have only a PlainText body, we'll us it; if we have both we'll use both:

Code Snippet

<span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> resultHtml = </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">;</span> <span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> resultText = </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">;</span>

<span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> htmlTemplate = </span><span style="background:#ffffff;color:#a31515;">""</span><span style="background:#ffffff;color:#000000;">; </span><span style="background:#ffffff;color:#008000;">// </span><span style="background:#ffffff;color:#00008b;">TODO: Load template from a CSHTML file</span> <span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> textTemplate = </span><span style="background:#ffffff;color:#a31515;">""</span><span style="background:#ffffff;color:#000000;">; </span><span style="background:#ffffff;color:#008000;">// </span><span style="background:#ffffff;color:#00008b;"><span style="background:#ffffff;color:#00008b;">TODO: Load template from a TXT file</span></span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> config = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">TemplateServiceConfiguration()</span><span style="background:#ffffff;color:#000000;">;</span> <span style="background:#ffffff;color:#0000ff;">using</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> service = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">TemplateService</span><span style="background:#ffffff;color:#000000;">(config))</span> <span style="font-size:10pt;">{</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (!</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrWhiteSpace(htmlTemplate))</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#000000;">resultHtml = service.Parse(htmlTemplate, model, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">);</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (!</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrWhiteSpace(textTemplate))</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#000000;">resultText = service.Parse(textTemplate, model, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">);</span> <span style="font-size:10pt;">} </span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> mailMessage = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">MailMessage</span> <span style="font-size:10pt;">{</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">BodyEncoding = </span><span style="background:#ffffff;color:#2b91af;">Encoding</span><span style="background:#ffffff;color:#000000;">.UTF8</span> <span style="font-size:10pt;">}; </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrEmpty(resultHtml))</span> <span style="font-size:10pt;">{</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">mailMessage.Body = resultText;</span> <span style="font-size:10pt;">}</span> <span style="color:#0000ff;font-size:10pt;">else</span> <span style="font-size:10pt;">{</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">mailMessage.IsBodyHtml = </span><span style="background:#ffffff;color:#0000ff;">true</span><span style="background:#ffffff;color:#000000;">;</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">mailMessage.Body = resultHtml;</span><span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (!</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrEmpty(resultText))</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">{</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#0000ff;">using</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> contentStream = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">MemoryStream</span><span style="background:#ffffff;color:#000000;">(</span><span style="background:#ffffff;color:#2b91af;">Encoding</span><span style="background:#ffffff;color:#000000;">.UTF8.GetBytes(resultText)))</span> <span style="font-size:10pt;">            </span><span style="background:#ffffff;color:#000000;">mailMessage.AlternateViews.Add(</span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">AlternateView</span><span style="background:#ffffff;color:#000000;">(contentStream, </span><span style="background:#ffffff;color:#a31515;">"text/plain"</span><span style="background:#ffffff;color:#000000;">));</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">}</span> <span style="font-size:10pt;">}</span>

Putting the logic in a nice abstract class
------------------------------------------

Putting the mailing logic in a nicely wrapped class allows us to hide it being an interface, as well as inherit from the class in order to create simple "mailer" classes. This will result in a pattern very similar to the Controller in ASP.Net MVC:

Code Snippet

<span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">abstract </span><span style="background:#ffffff;color:#0000ff;">class </span><span style="background:#ffffff;color:#2b91af;">MailerBase</span> <span style="font-size:10pt;">{</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">protected </span><span style="background:#ffffff;color:#2b91af;">MailMessage</span><span style="background:#ffffff;color:#000000;"> GenerateMail\<T\>(T model)</span> <span style="font-size:10pt;">    {</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#008000;">// ... all the code from the above section</span> <span style="font-size:10pt;">    } </span><span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">protected </span><span style="background:#ffffff;color:#0000ff;">void</span><span style="background:#ffffff;color:#000000;"> EmailAsync(</span><span style="background:#ffffff;color:#2b91af;">MailMessage</span><span style="background:#ffffff;color:#000000;"> mailMessage)</span> <span style="font-size:10pt;">    {</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> smtpClient = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">SmtpClient</span><span style="background:#ffffff;color:#000000;">(); </span><span style="font-size:10pt;">        smtpClient.SendCompleted += (sender, args) =\></span> <span style="font-size:10pt;">        {</span> <span style="background:#ffffff;color:#000000;">            </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (args.Error != </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">)</span> <span style="font-size:10pt;">            {</span> <span style="background:#ffffff;color:#000000;">                </span><span style="background:#ffffff;color:#008000;">// </span><span style="background:#ffffff;color:#00008b;">TODO: Do something with the error, such as logging it</span> <span style="font-size:10pt;">            }</span> <span style="font-size:10pt;">        };</span><span style="font-size:10pt;">        smtpClient.SendAsync(mailMessage, mailMessage);</span> <span style="font-size:10pt;">    }</span> <span style="font-size:10pt;">}</span>

We can now create a class that inherit from MailerBase, and can call GenerateMail to create a nicely formatted MailMessage. But this is not very useful if the template is hardcoded. Let's improve our template loading logic.

Locating the template like an MVC project
-----------------------------------------

It make sense to keep a project structure like a regular ASP.NET MVC project, even if we're not doing any ASP.Net - the separation of the templates from the model and from the code that sends the messages just makes common sense. So let's add a method to locate our template for us:

Code Snippet

<span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">virtual </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> ViewPath { </span><span style="background:#ffffff;color:#0000ff;">get</span><span style="background:#ffffff;color:#000000;">; </span><span style="background:#ffffff;color:#0000ff;">set</span><span style="background:#ffffff;color:#000000;">; }</span> <span style="background:#ffffff;color:#0000ff;">private </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> GetTemplate(</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> viewName, </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> extension = </span><span style="background:#ffffff;color:#a31515;">".html"</span><span style="background:#ffffff;color:#000000;">)</span> <span style="font-size:10pt;">{</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> filename;</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (!</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrEmpty(ViewPath))</span> <span style="font-size:10pt;">    {</span> <span style="background:#ffffff;color:#000000;">        filename = </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.Format(</span><span style="background:#ffffff;color:#a31515;">"Views/{</span><span style="background:#ffffff;color:#3cb371;">0}</span><span style="background:#ffffff;color:#a31515;">/{</span><span style="background:#ffffff;color:#3cb371;">1}{2}</span><span style="background:#ffffff;color:#a31515;">"</span><span style="background:#ffffff;color:#000000;">, ViewPath, viewName, extension);</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#2b91af;">File</span><span style="background:#ffffff;color:#000000;">.Exists(filename))</span> <span style="background:#ffffff;color:#000000;">            </span><span style="background:#ffffff;color:#0000ff;">return </span><span style="background:#ffffff;color:#2b91af;">File</span><span style="background:#ffffff;color:#000000;">.ReadAllText(filename);</span> <span style="font-size:10pt;">    }</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> typeName = GetType().Name;</span> <span style="background:#ffffff;color:#000000;">    filename = </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.Format(</span><span style="background:#ffffff;color:#a31515;">"Views/{</span><span style="background:#ffffff;color:#3cb371;">0}</span><span style="background:#ffffff;color:#a31515;">/{</span><span style="background:#ffffff;color:#3cb371;">1}{2}</span><span style="background:#ffffff;color:#a31515;">"</span><span style="background:#ffffff;color:#000000;">, typeName, viewName, extension);</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#2b91af;">File</span><span style="background:#ffffff;color:#000000;">.Exists(filename))</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">return </span><span style="background:#ffffff;color:#2b91af;">File</span><span style="background:#ffffff;color:#000000;">.ReadAllText(filename);</span> <span style="background:#ffffff;color:#000000;">    filename = </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.Format(</span><span style="background:#ffffff;color:#a31515;">"Views/{</span><span style="background:#ffffff;color:#3cb371;">0}{1}</span><span style="background:#ffffff;color:#a31515;">"</span><span style="background:#ffffff;color:#000000;">, viewName, extension);</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#2b91af;">File</span><span style="background:#ffffff;color:#000000;">.Exists(filename))</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">return </span><span style="background:#ffffff;color:#2b91af;">File</span><span style="background:#ffffff;color:#000000;">.ReadAllText(filename);</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">return </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">;</span> <span style="font-size:10pt;">}</span>

We can now change our GenerateMail method to get the template/view name, and load it dynamically:

Code Snippet

<span style="background:#ffffff;color:#0000ff;">protected </span><span style="background:#ffffff;color:#2b91af;">MailMessage</span><span style="background:#ffffff;color:#000000;"> GenerateMail\<T\>(T model, </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> viewName = </span><span style="background:#ffffff;color:#a31515;">""</span><span style="background:#ffffff;color:#000000;">)</span> <span style="font-size:10pt;">{</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> resultHtml = </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">;</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> resultText = </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;"><span style="background:#ffffff;color:#000000;">;</span></span><span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> htmlTemplate = GetTemplate(viewName);</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> textTemplate = GetTemplate(viewName, </span><span style="background:#ffffff;color:#a31515;">".txt"</span><span style="background:#ffffff;color:#000000;">);</span><span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#008000;">// ...rest of the method goes here...</span> <span style="font-size:10pt;">}</span>

Inheriting from MailerBase
--------------------------

We can now start to use MailerBase in a meaningful way. Let's create a sample mailer class:

Code Snippet

<span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">class </span><span style="background:#ffffff;color:#2b91af;">UserMailer</span><span style="background:#ffffff;color:#000000;"> : </span><span style="background:#ffffff;color:#2b91af;">MailerBase</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#2b91af;">IUserMailer</span> <span style="font-size:10pt;">{</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">void</span><span style="background:#ffffff;color:#000000;"> PasswordReset(</span><span style="background:#ffffff;color:#2b91af;">ResetViewModel</span><span style="background:#ffffff;color:#000000;"> viewModel)</span> <span style="font-size:10pt;">    {</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> message = GenerateMail(viewModel, </span><span style="background:#ffffff;color:#a31515;">"PasswordReset"</span><span style="background:#ffffff;color:#000000;">);</span> <span style="font-size:10pt;">        message.To.Add(viewModel.Email);</span> <span style="background:#ffffff;color:#000000;">        message.Subject = </span><span style="background:#ffffff;color:#a31515;">"Your Password reset request"</span><span style="background:#ffffff;color:#000000;">;</span> <span style="font-size:10pt;">        EmailAsync(message);</span> <span style="font-size:10pt;">    }</span> <span style="font-size:10pt;">}</span>

Looking at this code, something looks fishy - the "PasswordReset" string bothers me. Let's remove the need to manually pass the template name (unless the user wants to specify it explicitly). Let's change the signature of the GenerateMail method, and use the new <span style="color:black;"><span style="font-family:Consolas;font-size:9pt;"><span style="color:#2b91af;"><span style="background-color:white;">CallerMemberName </span></span></span>attribute</span>: <span style="color:blue;font-family:Consolas;font-size:9pt;"><span style="background-color:white;">protected <span style="color:black;"><span style="color:#2b91af;">MailMessage<span style="color:black;"> GenerateMail\<T\>(T model, [<span style="color:#2b91af;">CallerMemberName<span style="color:black;">] <span style="color:blue;">string<span style="color:black;"> viewName = <span style="color:#a31515;">""<span style="color:black;">)</span></span></span></span></span></span></span></span></span></span> </span> We can now call GenerateMail without specifying the view name, and the name of the calling method will be used automatically: <span style="color:blue;font-family:Consolas;font-size:9pt;background-color:white;">var<span style="color:black;"> message = GenerateMail(viewModel); </span></span>

Summary
-------

We now have a base class - MailerBase - which gives use the capability to easily send well formatted (using RazorEngine), multi-view (via AlternativeView), dynamically loaded (using the GetTemplate method and some <span style="color:#2b91af;font-family:Consolas;font-size:9pt;"><span style="background-color:white;">CallerMemberName </span></span>magic) emails. We've reached a state where creating new mailers is just as simple as creating ASP.Net MVC Controllers - you just inherit from MailerBase, and implement some very simple logic to generate the email message and send it. This should be enough for now. New time, we'll see how we can improve the HTML generated by RazorEngine to be even more end-user friendly.


