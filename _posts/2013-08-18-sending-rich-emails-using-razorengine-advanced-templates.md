---
layout: post
title: "Sending rich emails using RazorEngine - advanced templates"
date: 2013-08-18 13:08
author: saguiitay
comments: true
categories: [.Net, Development]
tags: [c#, development, email, MVC, RazorEngine]
---
In my previous post, I've shown how to use the RazorEngine template engine in order to generate EmailMessages in an MVC-like pattern. However, when compared to "real" MVC, we have the ability to create more complex views, using utility classes/methods, such as @Html and @Url. In this article we'll see how we can simulate that behavior, by using a custom Template base class. For this article, we're going to show how to embed a CSS file into the template, thus allowing us to generate more user-friendly email. Let's start with our code from the previous post, and see how we can improve it:
Code Snippet

<span style="background:#ffffff;color:#0000ff;">protected </span><span style="background:#ffffff;color:#2b91af;">MailMessage</span><span style="background:#ffffff;color:#000000;"> GenerateMail\<T\>(T model, [</span><span style="background:#ffffff;color:#2b91af;">CallerMemberName</span><span style="background:#ffffff;color:#000000;">] </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> viewName = </span><span style="background:#ffffff;color:#a31515;">""</span><span style="background:#ffffff;color:#000000;">)</span> <span style="background:#ffffff;color:#000000;">{</span> <span style="background:#ffffff;color:#0000ff;">    string</span><span style="background:#ffffff;color:#000000;"> resultHtml = </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">;</span> <span style="background:#ffffff;color:#0000ff;">    string</span><span style="background:#ffffff;color:#000000;"> resultText = </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">;</span><span style="background:#ffffff;color:#0000ff;">    var</span><span style="background:#ffffff;color:#000000;"> htmlTemplate = GetTemplate(viewName);</span> <span style="background:#ffffff;color:#0000ff;">    var</span><span style="background:#ffffff;color:#000000;"> textTemplate = GetTemplate(viewName, </span><span style="background:#ffffff;color:#a31515;">".txt"</span><span style="background:#ffffff;color:#000000;">);</span><span style="background:#ffffff;color:#0000ff;">    var</span><span style="background:#ffffff;color:#000000;"> config = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">TemplateServiceConfiguration()</span><span style="background:#ffffff;color:#000000;">;</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">using</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> service = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">TemplateService</span><span style="background:#ffffff;color:#000000;">(config))</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">{</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (!</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrWhiteSpace(htmlTemplate))</span> <span style="font-size:10pt;">            </span><span style="background:#ffffff;color:#000000;">resultHtml = service.Parse(htmlTemplate, model, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">);</span> <span style="background:#ffffff;color:#0000ff;">        if</span><span style="background:#ffffff;color:#000000;"> (!</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrWhiteSpace(textTemplate))</span> <span style="font-size:10pt;">            </span><span style="background:#ffffff;color:#000000;">resultText = service.Parse(textTemplate, model, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">, </span><span style="background:#ffffff;color:#0000ff;">null</span><span style="background:#ffffff;color:#000000;">);</span> <span style="background:#ffffff;color:#000000;">    }</span><span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> mailMessage = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">MailMessage</span> <span style="background:#ffffff;color:#000000;">        {</span> <span style="background:#ffffff;color:#000000;">            BodyEncoding = </span><span style="background:#ffffff;color:#2b91af;">Encoding</span><span style="background:#ffffff;color:#000000;">.UTF8</span> <span style="background:#ffffff;color:#000000;">        };</span><span style="background:#ffffff;color:#0000ff;">    if</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrEmpty(resultText) && </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrEmpty(resultHtml))</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#0000ff;">throw </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">InvalidOperationException</span><span style="background:#ffffff;color:#000000;">(</span><span style="background:#ffffff;color:#a31515;">"View was not found"</span><span style="background:#ffffff;color:#000000;">);</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrEmpty(resultHtml))</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">{</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#000000;">mailMessage.Body = resultText;</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">}</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#0000ff;">else</span> <span style="font-size:10pt;">    </span><span style="background:#ffffff;color:#000000;">{</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#000000;">mailMessage.IsBodyHtml = </span><span style="background:#ffffff;color:#0000ff;">true</span><span style="background:#ffffff;color:#000000;">;</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#000000;">mailMessage.Body = resultHtml;</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#0000ff;">if</span><span style="background:#ffffff;color:#000000;"> (!</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;">.IsNullOrEmpty(resultText))</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#000000;">{</span> <span style="font-size:10pt;">            </span><span style="background:#ffffff;color:#0000ff;">using</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> contentStream = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">MemoryStream</span><span style="background:#ffffff;color:#000000;">(</span><span style="background:#ffffff;color:#2b91af;">Encoding</span><span style="background:#ffffff;color:#000000;">.UTF8.GetBytes(resultText)))</span> <span style="font-size:10pt;">                </span><span style="background:#ffffff;color:#000000;">mailMessage.AlternateViews.Add(</span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">AlternateView</span><span style="background:#ffffff;color:#000000;">(contentStream, </span><span style="background:#ffffff;color:#a31515;">"text/plain"</span><span style="background:#ffffff;color:#000000;">));</span> <span style="font-size:10pt;">            </span><span style="background:#ffffff;color:#000000;">}</span> <span style="font-size:10pt;">        </span><span style="background:#ffffff;color:#000000;">}</span> <span style="background:#ffffff;color:#0000ff;">    return</span><span style="background:#ffffff;color:#000000;"> mailMessage;</span> <span style="background:#ffffff;color:#000000;">}</span>

The first thing we want to do, is to tell RazorEngine to use our own custom Template class:
Code Snippet

<span style="background:#ffffff;color:#0000ff;">var</span><span style="background:#ffffff;color:#000000;"> config = </span><span style="background:#ffffff;color:#0000ff;">new </span><span style="background:#ffffff;color:#2b91af;">TemplateServiceConfiguration</span><span style="background:#ffffff;color:#000000;"> { BaseTemplateType = </span><span style="background:#ffffff;color:#0000ff;">typeof</span><span style="background:#ffffff;color:#000000;">(</span><span style="background:#ffffff;color:#2b91af;">MvcTemplateBase</span><span style="background:#ffffff;color:#000000;">\<T\>) };</span>

Now let's go ahead and define the MvcTemplateBase class:
Code Snippet

<span style="background:#ffffff;color:#808080;">///</span><span style="background:#ffffff;color:#808080;">\<summary\></span> <span style="background:#ffffff;color:#808080;">///</span><span style="background:#ffffff;color:#008000;"> Provides a base implementation of an MVC-compatible template.</span> <span style="background:#ffffff;color:#808080;">///</span><span style="background:#ffffff;color:#808080;">\</summary\></span> <span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#0000ff;">abstract </span><span style="background:#ffffff;color:#0000ff;">class </span><span style="background:#ffffff;color:#2b91af;">MvcTemplateBase</span><span style="background:#ffffff;color:#000000;">\<T\> : </span><span style="background:#ffffff;color:#2b91af;">TemplateBase</span><span style="background:#ffffff;color:#000000;">\<T\> </span> <span style="font-size:10pt;">{</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">public </span><span style="background:#ffffff;color:#2b91af;">IEncodedString</span><span style="background:#ffffff;color:#000000;"> EmbedCss(</span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> path)</span> <span style="font-size:10pt;">    {</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#008000;">// load the contents of that file</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">string</span><span style="background:#ffffff;color:#000000;"> cssText;</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">try</span> <span style="font-size:10pt;">        {</span> <span style="background:#ffffff;color:#000000;">            cssText = </span><span style="background:#ffffff;color:#2b91af;">File</span><span style="background:#ffffff;color:#000000;">.ReadAllText(path);</span> <span style="font-size:10pt;">        }</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">catch</span><span style="background:#ffffff;color:#000000;"> (</span><span style="background:#ffffff;color:#2b91af;">Exception</span><span style="background:#ffffff;color:#000000;">)</span> <span style="font-size:10pt;">        {</span> <span style="background:#ffffff;color:#000000;">            </span><span style="background:#ffffff;color:#008000;">// blank string if we can't read the file for any reason</span> <span style="background:#ffffff;color:#000000;">            cssText = </span><span style="background:#ffffff;color:#a31515;">""</span><span style="background:#ffffff;color:#000000;">;</span> <span style="font-size:10pt;">        }</span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">return</span><span style="background:#ffffff;color:#000000;"> Raw(cssText);</span> <span style="font-size:10pt;">    }</span> <span style="font-size:10pt;">}</span>

Our class is quite simple - it's an abstract class that inherits from TemplateBase, and adds any utility method we need. Instead of a utility method, you can easily add a property to a utility class, such as Html, or Url. In our case, we've added a method that loads the content of a file, and output it as raw data. Finally, let's look at how our new template look like:
Code Snippet

<span style="background:#ffffff;color:#000000;">@inherits Namespace.MvcTemplateBase</span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">Namespace.ResetViewModel</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#0000ff;">\<!</span><span style="background:#ffffff;color:#800000;">DOCTYPE </span><span style="background:#ffffff;color:#ff0000;">html</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">html </span><span style="background:#ffffff;color:#ff0000;">lang</span><span style="background:#ffffff;color:#0000ff;">="en"\></span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">head</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">title</span><span style="background:#ffffff;color:#0000ff;">\></span><span style="background:#ffffff;color:#000000;">Custom Template sample</span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">title</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="font-size:10pt;">        @EmbedCss("Content/bootstrap.min.css")</span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">head</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">body</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">div </span><span style="background:#ffffff;color:#ff0000;">class</span><span style="background:#ffffff;color:#0000ff;">="container"\></span> <span style="background:#ffffff;color:#000000;">            </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">div </span><span style="background:#ffffff;color:#ff0000;">class</span><span style="background:#ffffff;color:#0000ff;">="hero-unit"\></span> <span style="background:#ffffff;color:#000000;">                </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">h1</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">                    Reset Password Request</span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">h1</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">                </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">p</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="font-size:10pt;">                    You requested to reset your password. Please click the following link to start the password reset process:</span> <span style="background:#ffffff;color:#000000;">                </span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">p</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">                </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">p</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">                    </span><span style="background:#ffffff;color:#0000ff;">\<</span><span style="background:#ffffff;color:#800000;">a </span><span style="background:#ffffff;color:#ff0000;">class</span><span style="background:#ffffff;color:#0000ff;">="btn btn-primary btn-large" </span><span style="background:#ffffff;color:#ff0000;">href</span><span style="background:#ffffff;color:#0000ff;">="@Model.Url"\></span> <span style="font-size:10pt;">                        Reset Password</span> <span style="background:#ffffff;color:#000000;">                    </span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">a</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">                </span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">p</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">            </span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">div</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">        </span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">div</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#000000;">    </span><span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">body</span><span style="background:#ffffff;color:#0000ff;">\></span> <span style="background:#ffffff;color:#0000ff;">\</</span><span style="background:#ffffff;color:#800000;">html</span><span style="background:#ffffff;color:#0000ff;">\></span>

As you can see, we have a simple html. Just like in ASP.Net, we use the @inherit keyword to declare the view inherits from MvcTemplateBase, and uses the ResetViewModel as our model. In the view itself, we can use the EmbedCss utility method by calling @EmbedCss('*file path*'). We can also use out model, by calling @Model - just like in ASP.Net MVC.  

